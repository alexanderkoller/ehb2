{% set contentwidth="span12" %}
{% extends "main.html" %}
{% import "macros.html" as m %}

{% block content %}

{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <hr/> <p class="error"> {{ message }} </p>
        {% endfor %}
    {% endif %}
{% endwith %}

<form class="form-horizontal" action="mailtool.html" method="post">
    <h2>Recipients</h2>
    <p>Please select the recipients from the table below using the checkboxes.</p>

    <table class="table table-striped pretty" id="datatable">
        <thead>
            <tr> <th></th>
                 <th>ID</th>
                 <th>Name</th> <th>Sex</th> <th>Location</th> <th>Part</th>
                 <th>Paypal</th> <th>Application time</th></tr>
        </thead>

        <tbody>
        {% for participant in participants %}
            <tr><td></td>
                <td>{{ participant.id }}</td>
                <td><a href="show-participant.html?id={{ participant.id }}">{{ participant.fullnameLF() }}</a></td>
                <td>{{ participant.shortsex() }}</td> <td>{{ participant.city_with_country() }}</td>
                <td>{{ participant.part1|part }}</td>
                <td>{{ participant.paypal_status.shortname() }}</td>
                <td>{{ participant.application_time|ft }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {{ form.recipients() }}


    <h2>Email Content</h2>
    <fieldset>
        {{ m.wtf(form.subject) }}
        {{ m.wtf(form.replyto) }}

        {{ m.wtf(form.body, fclass="ta") }}

        <!-- Buttons -->
        <div class="control-group">
            <label class="control-label" for="submit"></label>
            <div class="controls">
                <button id="submit" name="submit" type="submit" value="preview" class="btn btn-primary">Preview Emails</button>
                {#<button id="submit" name="submit" type="submit" value="dryrun" class="btn btn-primary" style="margin-left: 6em; margin-top: -4.2ex">Dry-Run</button> #}
            </div>
        </div>
    </fieldset>
</form>

<script type="text/javascript">
    $(document).ready(function() {
        // make datatable with checkboxes and multiple selections
        var table = $('#datatable').DataTable( {
            columnDefs: [ {
                    orderable: false,
                    className: 'select-checkbox',
                    targets:   0
                },
                {
                    targets: 1,
                    visible: false,
                    searchable: false
                }
            ],
            select: {
                style:    'multi',
                selector: 'td:first-child'
            },
            order: [[ 2, 'asc' ]]
        } );

        // initialize selection if a value for "recipients" was specified
        if( $('#recipients').val() ) {
            var ids = new Set($('#recipients').val().split(","));

            table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                var data = this.data();
                if( ids.has(data[1]) ) {
                    this.select();
                }
            });

/*
            var row_indices = table.rows().eq(0).filter( function (rowIdx) {
                return ids.has(table.cell( rowIdx, 1 ).data());
            } );




            console.log(indexes);
            */
        }

        // recompute value of "recipients" form field whenever selection changes
        var recomputeRecipients = function ( e, dt, type, indexes ) {
            var ids = $.map(table.rows('.selected').data(), function (item) {
                return item[1]
            });

            $('#recipients').val(ids.join());
        };

        table
            .on( 'select', recomputeRecipients)
            .on( 'deselect', recomputeRecipients);

    } );
</script>


{% endblock %}